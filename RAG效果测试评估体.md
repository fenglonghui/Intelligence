### RAG评估测试

####  RAG的评估测试
      RAG的本质是两个过程:
          1. 检索匹配
             a.大模型对问题的理解
             b.相似度排序
               根据问题结合当前的知识库去计算它的余弦相似度,匹配拿到top10作为回复的依据和材料

          2.评测
            核心是测试数据

#### 重排序召回率测试

      1.提供评测数据
        实际中评测数据是由甲方出, 给出标准

#### 提示词模版介绍

     提示词模版对于强模型能力下会按照提示模版的格式,规则输出信息, 提示词模版对于模型能力弱的大模型, 不起作用

#### 测试RAG知识库出现的问题
     比如, 提问:        试用期最长是多久?
          答案:        试用期最长6个月
          top10 回复:  输出10个语义最相近的答案, 但这10个问题中, 前两个答复正确, 后八个答复不正确甚至出现与问题无关但每个答复的相关度得分又比较接近, 难以区分!!!
      ```
          问题: 试用期最长多久？
          
          答案: 智能助手回答：
               根据《中华人民共和国劳动法》第二十一条的规定，劳动合同可以约定试用期，但试用期最长不得超过六个月。因此，试用期最长不得超过六个月。

          支持依据：
          
                [1] 中华人民共和国劳动法 第二十一条
                  来源文件：data1.json
                  法律名称：中华人民共和国劳动法
                  条款内容：劳动合同可以约定试用期。试用期最长不得超过六个月。...
#####             相关度得分：0.9179
                
                [2] 中华人民共和国劳动合同法 第十九条
                  来源文件：data1.json
                  法律名称：中华人民共和国劳动合同法
                  条款内容：劳动合同期限三个月以上不满一年的，试用期不得超过一个月；劳动合同期限一年以上不满三年的，试用期不得超过二个月；三年以上固定期限和无固定
                           期限的劳动合同，试用期不得超过六个月。
                           同一用人单位与同一劳动者只...
#####             相关度得分：0.9051
                
                [3] 中华人民共和国劳动法 第二十条
                  来源文件：data1.json
                  法律名称：中华人民共和国劳动法
                  条款内容：劳动合同的期限分为有固定期限、无固定期限和以完成一定的工作为期限。
                          劳动者在同一用人单位连续工作满十年以上，当事人双方同意续延劳动合同的，如果劳动者提出订立无固定期限的劳动合同，应当订立无固定期限的劳...
#####             相关度得分：0.8933
                
                [4] 中华人民共和国劳动合同法 第十五条
                  来源文件：data1.json
                  法律名称：中华人民共和国劳动合同法
                  条款内容：以完成一定工作任务为期限的劳动合同，是指用人单位与劳动者约定以某项工作的完成为合同期限的劳动合同。用人单位与劳动者协商一致，
                           可以订立以完成一定工作任务为期限的劳动合同。...
#####             相关度得分：0.8874
                
                [5] 中华人民共和国劳动合同法 第十四条
                  来源文件：data1.json
                  法律名称：中华人民共和国劳动合同法
                  条款内容：无固定期限劳动合同，是指用人单位与劳动者约定无确定终止时间的劳动合同。用人单位与劳动者协商一致，可以订立无固定期限劳动合同。
                          有下列情形之一，劳动者提出或者同意续订、订立劳动合同的，除劳动者提出订立固...
#####             相关度得分：0.8775
                
                [6] 中华人民共和国劳动合同法 第十二条
                  来源文件：data1.json
                  法律名称：中华人民共和国劳动合同法
                  条款内容：劳动合同分为固定期限劳动合同、无固定期限劳动合同和以完成一定工作任务为期限的劳动合同。...
#####             相关度得分：0.8747
                
                [7] 中华人民共和国劳动合同法 第十三条
                  来源文件：data1.json
                  法律名称：中华人民共和国劳动合同法
                  条款内容：固定期限劳动合同，是指用人单位与劳动者约定合同终止时间的劳动合同。用人单位与劳动者协商一致，可以订立固定期限劳动合同。...
#####             相关度得分：0.8722
                
                [8] 中华人民共和国劳动合同法 第二十条
                  来源文件：data1.json
                  法律名称：中华人民共和国劳动合同法
                  条款内容：劳动者在试用期的工资不得低于本单位相同岗位最低档工资或者劳动合同约定工资的百分之八十，并不得低于用人单位所在地的最低工资标准。...
#####             相关度得分：0.8706
                
                [9] 中华人民共和国劳动合同法 第二十四条
                  来源文件：data1.json
                  法律名称：中华人民共和国劳动合同法
                  条款内容：竞业限制的人员限于用人单位的高级管理人员、高级技术人员和其他负有保密义务的人员。竞业限制的范围、地域、期限由用人单位与劳动者约定，
                          竞业限制的约定不得违反法律、法规的规定。
                          在解除或者终止劳动合同后，前...
#####             相关度得分：0.8684
                
                [10] 中华人民共和国劳动合同法 第七十条
                  来源文件：data1.json
                  法律名称：中华人民共和国劳动合同法
                  条款内容：非全日制用工双方当事人不得约定试用期。...  
#####             相关度得分：0.8682

      ```

          答案虽然正确, 但支持依据出现了前2个依据是正确的,后8个依据不正确有的甚至和问题无关, 然后它们10个依据的相关度得分非常相近,没法明显的分界线难以区分开来
      
          这种问题的出现, 如何解决呢?
          使用重排序模型, 并设置相关度得分阈值即可解决这个问题!!!


####  重排序及对边界的处理

          重排序模型: 
                    BAAI/bge-reranker-large        精度高, 速度最慢
                    BAAI/bge-reranker-base         速度较快, 精度次高
                    
                    该模型所使用的算法(重排序算法只有两个): 
                        1.基于交叉熵算法来衡量相似度 
                        2.基于大模型生成式重新对文本进行理解和过滤 

          重排序组件: 
                    from llama_index.core.postprocessor import SentenceTransformerRerank

##### 重排序边界处理

       设置阈值: MIN_RERANK_SCORE = 0.4
       # 执行过滤
       filtered_nodes = [
           node for node in reranked_nodes
           if node.score > MIN_RERANK_SCORE
        ]    

#####     # 重排序边界处理
#####     if not filtered_nodes:
#####        print("你的问题未匹配到相关资料!")
#####        continue


####      重排序代码如下:
          ```
                  # 执行检索 -> 重排序 -> 过滤 -> 回答流程
                  start_time = time.time()
              
                  # 1.初始检索
                  initial_nodes = retriever.retrieve(question)
                  retrieval_time = time.time() - start_time
              
                  # 2.重排序
                  reranked_nodes = reranker.postprocess_nodes(
                    initial_nodes,
                    query_str=question
                  )
              
                  rerank_time = time.time() - start_time - retrieval_time
              
              
                  # ★★★★★    添加过滤逻辑 ★★★★★ 
                  
                  MIN_RERANK_SCORE = 0.4
              
                  # 执行过滤
                  filtered_nodes = [
                    node for node in reranked_nodes
                    if node.score > MIN_RERANK_SCORE
                  ]    
                  print("原始分数样例: ", [node.score for node in reranked_nodes[:3]])
                  print("重排序过滤后的结果: ", filtered_nodes)
              
                  if not filtered_nodes:
                     print("你的问题未匹配到相关资料!")
                     continue
              
              
                  # 合成答案 (使用过滤后的节点)
                  response = response_synthesizer.synthesize(
                    question, 
                    nodes=filtered_nodes  # 使用过滤后的节点
                  )
                  synthesis_time = time.time() - start_time - retrieval_time - rerank_time
              
              
                  # 显示结果
                  print(f"\n智能助手回答：\n{response.response}")
                  print("\n支持依据：")
                  for idx, node in enumerate(response.source_nodes, 1):
                      meta = node.metadata
                      print(f"\n[{idx}] {meta['full_title']}")
                      print(f"  来源文件: {meta['source_file']}")
                      print(f"  法律名称: {meta['law_name']}")
                      print(f"  初始相关度: {node.node.metadata.get('initial_score', 0):.4f}")   # 安全访问
                      print(f"  重排序得分: {getattr(node, 'score', 0):.4f}")     # 兼容属性访问
                      print(f"  条款内容: {node.node.text[:100]}...")
              
                  print(f"\n[性能分析] 检索: {retrieval_time:.2f}s | 重排序: {rerank_time:.2f}s | 合成: {synthesis_time:.2f}s")

          ```

#### 重排序之后, 进行RAG测试评估

        测试指标: 重排序召回率、端到端命中率(精度)、设置TOP_K和RERANK_TOP_K

        1.重排序召回率、端到端命中率(精度) 这两个评估的是RAG的精度
        
        2.设置TOP_K和RERANK_TOP_K 这两个设置是关于性能(速度)的指标

        整体上讲, RAG的评估本质平衡性能和精度, 就是关于上述 1 和 2的平衡; 
        可以这么理解: 
                   也就是 TOP_K 和 RERANK_TOP_K 的值设置高, 重排序召回率、端到端命中率的值就高了, 但性能就低了(速度慢了)
                   反之 TOP_K 和 RERANK_TOP_K 的值设置低, 性能就高了(速度快了), 但重排序召回率、端到端命中率的值就低
        
                       
